{"version":3,"file":"dynamic_tabs.min.js","sources":["../src/dynamic_tabs.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Dynamic Tabs UI element with AJAX loading of tabs content\n *\n * @module      core/dynamic_tabs\n * @copyright   2021 David Matamoros <davidmc@moodle.com> based on code from Marina Glancy\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Templates from 'core/templates';\nimport {addIconToContainer} from 'core/loadingicon';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport {get_strings as getStrings} from 'core/str';\nimport {getContent} from 'core/local/repository/dynamic_tabs';\nimport {isAnyWatchedFormDirty, resetAllFormDirtyStates} from 'core_form/changechecker';\n\nconst SELECTORS = {\n    dynamicTabs: '.dynamictabs',\n    activeTab: '.dynamictabs .nav-link.active',\n    allActiveTabs: '.dynamictabs .nav-link[data-toggle=\"tab\"]:not(.disabled)',\n    tabContent: '.dynamictabs .tab-pane [data-tab-content]',\n    tabToggle: 'a[data-toggle=\"tab\"]',\n    tabPane: '.dynamictabs .tab-pane',\n};\n\nSELECTORS.forTabName = tabName => `.dynamictabs [data-tab-content=\"${tabName}\"]`;\nSELECTORS.forTabId = tabName => `.dynamictabs [data-toggle=\"tab\"][href=\"#${tabName}\"]`;\n\n/**\n * Initialises the tabs view on the page (only one tabs view per page is supported)\n */\nexport const init = () => {\n    const tabToggle = $(SELECTORS.tabToggle);\n\n    // Listen to click, warn user if they are navigating away with unsaved form changes.\n    tabToggle.on('click', (event) => {\n        if (!isAnyWatchedFormDirty()) {\n            return;\n        }\n\n        event.preventDefault();\n        event.stopPropagation();\n\n        getStrings([\n            {key: 'changesmade', component: 'moodle'},\n            {key: 'changesmadereallygoaway', component: 'moodle'},\n            {key: 'confirm', component: 'moodle'},\n        ]).then(([strChangesMade, strChangesMadeReally, strConfirm]) =>\n            // Reset form dirty state on confirmation, re-trigger the event.\n            Notification.confirm(strChangesMade, strChangesMadeReally, strConfirm, null, () => {\n                resetAllFormDirtyStates();\n                $(event.target).trigger(event.type);\n            })\n        ).catch(Notification.exception);\n    });\n\n    // This code listens to Bootstrap events 'show.bs.tab' and 'shown.bs.tab' which is triggered using JQuery and\n    // can not be converted yet to native events.\n    tabToggle\n        .on('show.bs.tab', function() {\n            // Clean content from previous tab.\n            const previousTabName = getActiveTabName();\n            if (previousTabName) {\n                const previousTab = document.querySelector(SELECTORS.forTabName(previousTabName));\n                previousTab.textContent = '';\n            }\n        })\n        .on('shown.bs.tab', function() {\n            const tab = $($(this).attr('href'));\n            if (tab.length !== 1) {\n                return;\n            }\n            loadTab(tab.attr('id'));\n        });\n\n    if (!openTabFromHash()) {\n        const tabs = document.querySelector(SELECTORS.allActiveTabs);\n        if (tabs) {\n            openTab(tabs.getAttribute('aria-controls'));\n        } else {\n            // We may hide tabs if there is only one available, just load the contents of the first tab.\n            const tabPane = document.querySelector(SELECTORS.tabPane);\n            if (tabPane) {\n                tabPane.classList.add('active', 'show');\n                loadTab(tabPane.getAttribute('id'));\n            }\n        }\n    }\n};\n\n/**\n * Returns id/name of the currently active tab\n *\n * @return {String|null}\n */\nconst getActiveTabName = () => {\n    const element = document.querySelector(SELECTORS.activeTab);\n    return element?.getAttribute('aria-controls') || null;\n};\n\n/**\n * Returns the id/name of the first tab\n *\n * @return {String|null}\n */\nconst getFirstTabName = () => {\n    const element = document.querySelector(SELECTORS.tabContent);\n    return element?.dataset.tabContent || null;\n};\n\n/**\n * Loads contents of a tab using an AJAX request\n *\n * @param {String} tabName\n */\nconst loadTab = (tabName) => {\n    // If tabName is not specified find the active tab, or if is not defined, the first available tab.\n    tabName = tabName ?? getActiveTabName() ?? getFirstTabName();\n    const tab = document.querySelector(SELECTORS.forTabName(tabName));\n    if (!tab) {\n        return;\n    }\n\n    const pendingPromise = new Pending('core/dynamic_tabs:loadTab:' + tabName);\n\n    addIconToContainer(tab)\n    .then(() => {\n        let tabArgs = {...tab.dataset};\n        delete tabArgs.tabClass;\n        delete tabArgs.tabContent;\n        return getContent(tab.dataset.tabClass, JSON.stringify(tabArgs));\n    })\n    .then(response => Promise.all([\n        $.parseHTML(response.javascript, null, true).map(node => node.innerHTML).join(\"\\n\"),\n        Templates.renderForPromise(response.template, JSON.parse(response.content)),\n    ]))\n    .then(([responseJs, {html, js}]) => Templates.replaceNodeContents(tab, html, js + responseJs))\n    .then(() => pendingPromise.resolve())\n    .catch(Notification.exception);\n};\n\n/**\n * Return the tab given the tab name\n *\n * @param {String} tabName\n * @return {HTMLElement}\n */\nconst getTab = (tabName) => {\n    return document.querySelector(SELECTORS.forTabId(tabName));\n};\n\n/**\n * Return the tab pane given the tab name\n *\n * @param {String} tabName\n * @return {HTMLElement}\n */\nconst getTabPane = (tabName) => {\n    return document.getElementById(tabName);\n};\n\n/**\n * Open the tab on page load. If this script loads before theme_boost/tab we need to open tab ourselves\n *\n * @param {String} tabName\n * @return {Boolean}\n */\nconst openTab = (tabName) => {\n    const tab = getTab(tabName);\n    if (!tab) {\n        return false;\n    }\n\n    loadTab(tabName);\n    tab.classList.add('active');\n    getTabPane(tabName).classList.add('active', 'show');\n    return true;\n};\n\n/**\n * If there is a location hash that is the same as the tab name - open this tab.\n *\n * @return {Boolean}\n */\nconst openTabFromHash = () => {\n    const hash = document.location.hash;\n    if (hash.match(/^#\\w+$/g)) {\n        return openTab(hash.replace(/^#/g, ''));\n    }\n\n    return false;\n};\n"],"names":["_interopRequireDefault","e","__esModule","default","ownKeys","r","t","Object","keys","getOwnPropertySymbols","o","filter","getOwnPropertyDescriptor","enumerable","push","apply","_defineProperty","i","Symbol","toPrimitive","call","TypeError","String","Number","_toPrimitive","_toPropertyKey","defineProperty","value","configurable","writable","_jquery","_templates","_notification","_pending","SELECTORS","dynamicTabs","activeTab","allActiveTabs","tabContent","tabToggle","tabPane","tabName","concat","_exports","init","$","on","event","isAnyWatchedFormDirty","preventDefault","stopPropagation","getStrings","key","component","then","_ref","strChangesMade","strChangesMadeReally","strConfirm","Notification","confirm","resetAllFormDirtyStates","target","trigger","type","catch","exception","previousTabName","getActiveTabName","document","querySelector","forTabName","textContent","tab","this","attr","length","loadTab","openTabFromHash","tabs","openTab","getAttribute","classList","add","element","_ref2","_tabName","getFirstTabName","dataset","pendingPromise","Pending","addIconToContainer","tabArgs","arguments","forEach","getOwnPropertyDescriptors","defineProperties","_objectSpread","tabClass","getContent","JSON","stringify","response","Promise","all","parseHTML","javascript","map","node","innerHTML","join","Templates","renderForPromise","template","parse","content","_ref3","responseJs","html","js","replaceNodeContents","resolve","forTabId","getTab","getElementById","getTabPane","hash","location","match","replace"],"mappings":"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"}